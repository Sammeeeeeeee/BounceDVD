FROM caddy:2.7.6-alpine AS base

ARG CADDY_VERSION=2.7.6
ARG BUILD_DATE
ARG VCS_REF

LABEL maintainer="sam@samhosted.uk" \
      version="0.2.0" \
      description="Secure DVD Bounce Application" \
      build-date=$BUILD_DATE \
      vcs-ref=$VCS_REF \
      security.scan="required" \
      vendor="Sam"

# Create non-root user
RUN addgroup -g 65532 -S dvdapp && \
    adduser -u 65532 -S dvdapp -G dvdapp

# Minimal packages, then clean
RUN apk add --no-cache \
      ca-certificates \
      curl \
      tzdata && \
    rm -rf /var/cache/apk/* /tmp/* /var/tmp/*

FROM base AS final

# Copy app files and Caddyfile
COPY --chown=dvdapp:dvdapp ./app /srv
COPY --chown=dvdapp:dvdapp ./docker/caddyfile /etc/caddy/Caddyfile

# Create and own writable dirs
RUN mkdir -p /var/log/caddy /data && \
    chown -R dvdapp:dvdapp /var/log/caddy /data && \
    chmod 755 /var/log/caddy /data

# Set correct permissions
RUN find /srv -type f \( -name "*.tmp" -o -name "*.log" -o -name "*.bak" \) -delete && \
    find /srv -type f -exec chmod 644 {} \; && \
    find /srv -type d -exec chmod 755 {} \;

# Run as non-root
USER dvdapp:dvdapp

ENV CADDYFILE_PATH=/etc/caddy/Caddyfile \
    CADDY_ADMIN=off \
    TZ=UTC

HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:80/health || exit 1

EXPOSE 80 443

VOLUME ["/data", "/var/log/caddy"]

ENTRYPOINT ["caddy", "run", "--config", "/etc/caddy/Caddyfile"]
